#!/usr/bin/env bash
# Claude Code status line script
# Receives JSON session data on stdin, outputs formatted text lines

data=$(cat)

model=$(echo "$data" | jq -r '.model.display_name // "unknown"')
context_pct=$(echo "$data" | jq -r '.context_window.used_percentage // 0' | cut -d. -f1)

# Build a simple progress bar for context usage
bar_width=10
filled=$(( context_pct * bar_width / 100 ))
empty=$(( bar_width - filled ))
bar=$(printf '%0.s█' $(seq 1 $filled 2>/dev/null))
bar+=$(printf '%0.s░' $(seq 1 $empty 2>/dev/null))

date_str=$(date +%Y-%m-%d\ %H:%M:%S)

# Fetch cached usage limits (gracefully skipped if unavailable)
usage=$(claude-fetch-usage 2>/dev/null)
if [[ -n "$usage" ]]; then
  five_hour_pct=$(echo "$usage" | jq -r 'if (.five_hour.utilization | type) == "number" then (.five_hour.utilization * 100 | floor | tostring) + "%" else empty end' 2>/dev/null)
  seven_day_pct=$(echo "$usage" | jq -r 'if (.seven_day.utilization | type) == "number" then (.seven_day.utilization * 100 | floor | tostring) + "%" else empty end' 2>/dev/null)
fi

status="${date_str} [$model] ${bar} ${context_pct}% ctx"
if [[ -n "${five_hour_pct:-}" && -n "${seven_day_pct:-}" ]]; then
  status+=" | 5h:${five_hour_pct} 7d:${seven_day_pct}"
fi
echo "$status"
